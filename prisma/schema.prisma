generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ─── User ────────────────────────────────────────────────────────────────────

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  image           String?
  defaultCurrency String   @default("BRL")
  locale          String   @default("pt-BR")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  accounts     Account[]
  categories   Category[]
  transactions Transaction[]
  budgets      Budget[]
  currencies   UserCurrency[]

  @@map("users")
}

// ─── UserCurrency ────────────────────────────────────────────────────────────

model UserCurrency {
  id        String   @id @default(cuid())
  userId    String
  currency  String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, currency])
  @@map("user_currencies")
}

// ─── Account ─────────────────────────────────────────────────────────────────

enum AccountType {
  CASH
  CHECKING
  BANK
  CREDIT_CARD
  INVESTMENT
}

model Account {
  id        String      @id @default(cuid())
  userId    String
  name      String
  type      AccountType @default(BANK)
  balance   Decimal     @default(0) @db.Decimal(14, 2)
  currency  String      @default("BRL")
  color     String?
  icon      String?
  bankKey   String?
  bankName  String?
  isActive  Boolean     @default(true)
  isDefault Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("accounts")
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model Category {
  id        String          @id @default(cuid())
  userId    String?
  name      String
  type      TransactionType
  icon      String?
  color     String?
  parentId  String?
  createdAt DateTime        @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       Category?     @relation("CategoryParent", fields: [parentId], references: [id])
  children     Category[]    @relation("CategoryParent")
  transactions Transaction[]
  budgets      Budget[]

  @@map("categories")
}

// ─── Frequency ───────────────────────────────────────────────────────────────

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// ─── Transaction ─────────────────────────────────────────────────────────────

enum TransactionStatus {
  PAID
  PENDING
}

model Transaction {
  id                      String            @id @default(cuid())
  userId                  String
  accountId               String
  categoryId              String?
  type                    TransactionType
  amount                  Decimal           @db.Decimal(14, 2)
  currency                String            @default("BRL")
  amountInDefaultCurrency Decimal           @default(0) @db.Decimal(14, 2)
  exchangeRateUsed        Decimal           @default(1) @db.Decimal(14, 6)
  description             String?
  date                    DateTime
  status                  TransactionStatus @default(PAID)
  isRecurring             Boolean           @default(false)
  frequency               Frequency?
  recurrenceEnd           DateTime?
  parentTransactionId     String?
  metadata                Json?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  account           Account       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  category          Category?     @relation(fields: [categoryId], references: [id])
  parentTransaction Transaction?  @relation("TransactionChildren", fields: [parentTransactionId], references: [id], onDelete: SetNull)
  childTransactions Transaction[] @relation("TransactionChildren")

  @@index([userId, date])
  @@index([userId, accountId])
  @@index([userId, categoryId])
  @@index([userId, isRecurring])
  @@map("transactions")
}

// ─── Budget ───────────────────────────────────────────────────────────────────

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  YEARLY
}

model Budget {
  id         String       @id @default(cuid())
  userId     String
  categoryId String?
  name       String
  amount     Decimal      @db.Decimal(14, 2)
  period     BudgetPeriod @default(MONTHLY)
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])

  @@map("budgets")
}
